<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Event Logger</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #eventFormContainer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.6); overflow-y: auto; }
    #eventForm { background: #fff; margin: 50px auto; padding: 20px; width: 90%; max-width: 600px; border-radius: 8px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 4px; }
    button { margin-top: 15px; padding: 10px 15px; }
    #buttons { display: flex; justify-content: space-between; }
  </style>
</head>
<body>

  <button id="startButton">Start New Event</button>

  <div id="eventFormContainer">
    <div id="eventForm">
      <h2>New Event Entry V3</h2>

      <label>Collection (required)</label>
      <select id="collection" required>
        <option value="">--Select Collection--</option>
        <option value="Meal">Meal</option>
        <option value="Bathroom">Bathroom</option>
        <option value="Rest">Rest</option>
        <option value="Activity">Activity</option>
      </select>

      <label>Event (required)</label>
      <input type="text" id="event" placeholder="Event name" required>

      <label>SubEvent 1</label>
      <input type="text" id="sub1">

      <label>SubEvent 2</label>
      <input type="text" id="sub2">

      <label>SubEvent 3</label>
      <input type="text" id="sub3">

      <label>Duration (minutes)</label>
      <input type="number" id="duration" min="0">

      <label>Start Date</label>
      <input type="date" id="startDate">

      <label>Start Time</label>
      <input type="time" id="startTime">

      <label>Rating</label>
      <input type="text" id="rating">

      <label>Notes</label>
      <textarea id="notes" rows="3"></textarea>

      <label>Photo URLs (comma-separated)</label>
      <textarea id="photoUrls" rows="2"></textarea>

      <div id="buttons">
        <button id="submitButton">Submit Event</button>
        <button id="cancelButton" type="button">Cancel</button>
      </div>
    </div>
  </div>

<script>
const POST_URL = 'https://script.google.com/macros/s/AKfycbyPvOF3PQUwZS6HR5qWYR8j1fepvIRH4RjjU5iU5u1K5OSGrhxI4X8MF5IGPW71aUpw/exec';

let timestamp = '';

const startButton = document.getElementById('startButton');
const formContainer = document.getElementById('eventFormContainer');
const cancelButton = document.getElementById('cancelButton');
const submitButton = document.getElementById('submitButton');

startButton.addEventListener('click', () => {
  timestamp = new Date().toISOString();
  console.log('Event started at:', timestamp);
  formContainer.style.display = 'block';
});

cancelButton.addEventListener('click', () => {
  // Clear all fields
  document.getElementById('collection').value = '';
  document.getElementById('event').value = '';
  document.getElementById('sub1').value = '';
  document.getElementById('sub2').value = '';
  document.getElementById('sub3').value = '';
  document.getElementById('duration').value = '';
  document.getElementById('startDate').value = '';
  document.getElementById('startTime').value = '';
  document.getElementById('rating').value = '';
  document.getElementById('notes').value = '';
  document.getElementById('photoUrls').value = '';
  formContainer.style.display = 'none';
  timestamp = '';
  console.log('Form canceled');
});

submitButton.addEventListener('click', async () => {
  const collection = document.getElementById('collection').value;
  const eventType = document.getElementById('event').value;

  if (!collection || !eventType) {
    alert('Collection and Event are required.');
    return;
  }

  const startDate = document.getElementById('startDate').value;
  const startTime = document.getElementById('startTime').value;
  if (startDate && !startTime) {
    alert('Start Time is required if Start Date is set.');
    return;
  }

  const data = {
    action: 'submitEvent',
    Timestamp: timestamp,
    Date: new Date().toISOString().split('T')[0],
    Time: new Date().toISOString().split('T')[1].split('.')[0],
    StartDate: startDate,
    StartTime: startTime,
    Duration: document.getElementById('duration').value,
    Collection: collection,
    Event: eventType,
    SubEvent_1: document.getElementById('sub1').value,
    SubEvent_2: document.getElementById('sub2').value,
    SubEvent_3: document.getElementById('sub3').value,
    Rating: document.getElementById('rating').value,
    Notes: document.getElementById('notes').value,
    Photo: document.getElementById('photoUrls').value
  };

  console.log('Submitting event data:', data);

  try {
    const response = await fetch(POST_URL, {
      method: 'POST',
      body: JSON.stringify(data),
      headers: { 'Content-Type': 'application/json' }
    });

    console.log('Raw response:', response);
    const json = await response.json();
    console.log('Parsed response:', json);

    if (json.status === 'success') {
      alert('Event submitted successfully!');
      cancelButton.click(); // reset form after submit
    } else {
      alert('Error: ' + json.message);
    }
  } catch (err) {
    console.error('Fetch error:', err);
    alert('Fetch failed: ' + err.message);
  }
});
</script>

</body>
</html>
